<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ATC Drill (PWA v3, compat)</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#111111">
<style>
  :root{--gap:12px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;line-height:1.35;background:#f7f7f9}
  h1{font-size:18px;margin:0 0 8px}
  .card{background:#fff;border:1px solid #e6e6ea;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  .label{font-size:13px;color:#666;display:flex;align-items:center;gap:6px}
  .hint{font-size:12px;color:#999;border:1px solid #ddd;border-radius:6px;padding:1px 6px}
  .digit-grid{display:flex;gap:8px}
  .digit{width:54px;height:58px;border:1px solid #d7d7de;border-radius:12px;font-size:24px;text-align:center;background:#fff;cursor:pointer}
  .focus-ring{outline:2px solid #3182f6;border-color:#3182f6}
  .note{font-size:12px;color:#777}
  button{padding:12px 14px;border:1px solid #d0d0d8;border-radius:12px;background:#fff;cursor:pointer}
  button:active{transform:scale(0.98)}
  .primary{background:#111;color:#fff;border-color:#111}
  .danger{background:#ff3b30;color:#fff;border-color:#ff3b30}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .muted{color:#666}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:920px){ .grid{grid-template-columns:1fr 1fr} }
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#555}
  .tx{color:#fff;background:#ff3b30;border-color:#ff3b30}
  .sheet-backdrop{position:fixed;inset:0;background:transparent;display:none;z-index:1000}
  .sheet{position:fixed;left:50%;transform:translate(-50%,110%);bottom:10px;background:#fff;border-radius:14px;
    box-shadow:0 6px 20px rgba(0,0,0,.18);padding:8px 10px 10px;z-index:1001;transition:transform .18s ease;width:min(92vw,340px)}
  .sheet.show{transform:translate(-50%,0)}
  .sheet-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .kp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .kp-btn{padding:12px 0;border-radius:10px;border:1px solid #d7d7de;background:#fff;font-size:20px}
  .kp-func{font-size:14px}
  .kp-target{font-weight:600}
  .blur-wrap{position:relative;cursor:pointer}
  .blurred{filter:blur(6px);user-select:none}
  .blur-hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#333;background:rgba(255,255,255,.6);border-radius:10px;font-size:13px}
  .hidden{display:none}
  #logList{max-height:240px;overflow:auto;margin-top:8px}
  #logList .log-item{border-top:1px dashed #e5e5e9;padding:8px 0}
  .control{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select, input[type="range"]{padding:6px;border:1px solid #d0d0d8;border-radius:10px}

  /* --- Approach Generator 스타일 --- */
  .approach-wrap{display:flex;flex-direction:column;gap:10px}
  .ap-row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
  .ap-box{flex:0 0 auto}
  .ap-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed #d0d0d8;border-radius:999px;color:#555;background:#fafafa}
  .ap-digit{width:56px;height:60px;border-radius:14px;font-size:26px}
  .ap-mid{font-weight:700;font-size:22px;padding:0 6px}
  .ap-big{font-size:28px;font-weight:800;padding:0 12px;border-radius:12px;background:#111;color:#fff;border:1px solid #111}
  .ap-big small{font-size:14px;font-weight:600;opacity:.9;margin-left:6px}
  .ap-range{font-size:13px;color:#666;margin-left:6px}
  .ap-value{font-size:28px;font-weight:800}
  #diag{margin-top:10px;font-size:12px;color:#b00020}
</style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <h1>ATC Drill (PWA v3)</h1>
        <div class="muted">H/A/S 이동 · N(Next)/B(Say again)/I(Init)/R(Reinit) · <b>Space</b>=Instruction 토글 · <b>G</b>=Approach Generate</div>
      </div>
      <div class="control">
        <label class="label">Voice <select id="voiceSel"></select></label>
        <label class="label">Rate <input type="range" id="rate" min="0.6" max="1.5" step="0.01" value="0.9"></label>
        <label class="label">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.01" value="0.9"></label>
        <span id="txLamp" class="pill hidden tx">TX</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- 입력/난이도 -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="col" style="flex:1">
          <span class="label">Difficulty</span>
          <select id="difficulty" style="padding:10px;border:1px solid #ccc;border-radius:10px">
            <option value="1">1 - Easy (±1000/2000ft, SPD 유지, 180° turn, 1000/1500FPM)</option>
            <option value="2">2 - Normal (±1000/2000ft, SPD ±20kt, 180° turn, 1000/1500FPM)</option>
            <option value="3" selected>3 - Hard (가변 규칙, 상승 1000/1500/2000)</option>
          </select>
        </div>
      </div>
      <hr style="margin:14px 0;border:none;border-top:1px solid #eee" />
      <div class="row">
        <div class="col" style="flex:1">
          <span class="label">Heading <span class="hint">H</span></span>
          <div class="digit-grid" id="headingBlock">
            <input class="digit" id="h1" readonly maxlength="1" />
            <input class="digit" id="h2" readonly maxlength="1" />
            <input class="digit" id="h3" readonly maxlength="1" />
          </div>
          <div class="note mono" id="hdgPreview">HDG: 000°</div>
        </div>
        <div class="col" style="flex:1">
          <span class="label">Altitude (XX00) <span class="hint">A</span></span>
          <div class="digit-grid" id="altBlock">
            <input class="digit" id="a1" readonly maxlength="1" />
            <input class="digit" id="a2" readonly maxlength="1" />
            <div style="display:flex;align-items:center;font-weight:600">00 ft</div>
          </div>
          <div class="note mono" id="altPreview">ALT: —</div>
        </div>
        <div class="col" style="flex:1">
          <span class="label">Speed (XX0) <span class="hint">S</span></span>
          <div class="digit-grid" id="speedBlock">
            <input class="digit" id="s1" readonly maxlength="1" />
            <input class="digit" id="s2" readonly maxlength="1" />
            <div style="display:flex;align-items:center;font-weight:600">0 kt</div>
          </div>
          <div class="note mono" id="spdPreview">SPD: —</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;flex-wrap:wrap;gap:10px">
        <button id="btnInit" class="primary">Initialize <span class="hint">I</span></button>
        <button id="btnReinit" class="danger">Reinitialize <span class="hint">R</span></button>
        <span id="initMsg" class="note"></span>
      </div>
    </div>

    <!-- 인스트럭션/로그/어프로치 -->
    <div class="card">
      <div class="row" style="flex-wrap:wrap;gap:10px">
        <button id="sayAgain">Say Again <span class="hint">B</span></button>
        <button id="next" class="primary">Next Instruction <span class="hint">N</span></button>
      </div>
      <div class="card blur-wrap" style="margin-top:14px">
        <div class="label">Instruction (현재) <span class="hint">Space</span></div>
        <div id="textOut" class="mono blurred" style="white-space:pre-wrap;font-size:15px"></div>
        <div id="blurHint" class="blur-hint">터치 또는 Space로 보기</div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="label">Instruction Log</div>
        <div id="logList"></div>
      </div>

      <!-- Approach Speed Generator (개선) -->
      <div class="card" style="margin-top:14px">
        <div class="label">Approach Speed Generator <span class="ap-chip">기본 145–152 kt</span></div>
        <div class="approach-wrap">
          <div class="ap-row">
            <div class="ap-box">
              <span class="label">Min (kt)</span>
              <div class="digit-grid" id="apprMinBlock">
                <input class="digit ap-digit" id="pmin1" readonly maxlength="1" />
                <input class="digit ap-digit" id="pmin2" readonly maxlength="1" />
                <input class="digit ap-digit" id="pmin3" readonly maxlength="1" />
              </div>
            </div>
            <div class="ap-mid">~</div>
            <div class="ap-box">
              <span class="label">Max (kt)</span>
              <div class="digit-grid" id="apprMaxBlock">
                <input class="digit ap-digit" id="pmax1" readonly maxlength="1" />
                <input class="digit ap-digit" id="pmax2" readonly maxlength="1" />
                <input class="digit ap-digit" id="pmax3" readonly maxlength="1" />
              </div>
            </div>
            <div class="ap-box" style="margin-left:auto">
              <button id="btnApproach" class="ap-big">Generate <small>G</small></button><span class="ap-range" id="apprRangeNote">범위: 145–152 kt</span>
            </div>
          </div>
          <div class="ap-row">
            <div class="label">Result</div>
            <div class="ap-value mono" id="apprVal">—</div>
          </div>
        </div>
        <div class="note">* 이 범위는 위 툴과 독립적입니다. 숫자 입력은 팝업 키패드로만 가능합니다.</div>
      </div>

      <div id="diag"></div>
    </div>
  </div>

  <!-- Keypad -->
  <div id="backdrop" class="sheet-backdrop"></div>
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="sheet-head">
      <div>입력: <span class="kp-target" id="kpTarget">—</span></div>
      <button id="kpClose" class="kp-btn kp-func">닫기</button>
    </div>
    <div class="kp-grid" style="margin-bottom:8px">
      <button class="kp-btn">1</button><button class="kp-btn">2</button><button class="kp-btn">3</button>
      <button class="kp-btn">4</button><button class="kp-btn">5</button><button class="kp-btn">6</button>
      <button class="kp-btn">7</button><button class="kp-btn">8</button><button class="kp-btn">9</button>
      <button class="kp-btn kp-func" data-func="clear">C</button>
      <button class="kp-btn">0</button>
      <button class="kp-btn kp-func" data-func="back">⌫</button>
    </div>
  </div>

<script>
/* ===== 화면 에러 표기 ===== */
(function(){
  var diag=document.getElementById('diag');
  window.onerror=function(msg,src,line,col,err){ diag.textContent='[Error] '+msg+' @'+line+':'+col; };
})();

/* ===== TTS (Samantha 우선) ===== */
var voiceSel=document.getElementById('voiceSel');
var rateEl=document.getElementById('rate');
var pitchEl=document.getElementById('pitch');
var txLamp=document.getElementById('txLamp');

function loadVoices(){
  try{
    var vs=window.speechSynthesis?window.speechSynthesis.getVoices():[];
    var prev=voiceSel.value||''; voiceSel.innerHTML='';
    for(var i=0;i<vs.length;i++){ var v=vs[i],opt=document.createElement('option'); opt.value=v.name; opt.textContent=v.name+' ('+v.lang+')'; voiceSel.appendChild(opt); }
    var opts=voiceSel.options;
    if(prev){ for(var j=0;j<opts.length;j++){ if(opts[j].value===prev){ voiceSel.value=prev; return; } } }
    for(var j1=0;j1<opts.length;j1++){ if(/Samantha/.test(opts[j1].value)){ voiceSel.value=opts[j1].value; return; } }
    for(var j2=0;j2<opts.length;j2++){ if(/\(en-US\)/.test(opts[j2].textContent)){ voiceSel.value=opts[j2].value; return; } }
    for(var j3=0;j3<opts.length;j3++){ if(/\(en-/.test(opts[j3].textContent)){ voiceSel.value=opts[j3].value; return; } }
    if(opts.length) voiceSel.selectedIndex=0;
  }catch(e){ document.getElementById('diag').textContent='[Voices] '+e.message; }
}
if('speechSynthesis' in window){ loadVoices(); window.speechSynthesis.onvoiceschanged=loadVoices; }

function speak(text){
  if(!('speechSynthesis' in window)) return;
  var u=new SpeechSynthesisUtterance(text);
  var voices=window.speechSynthesis.getVoices(), chosen=null, wanted=voiceSel?voiceSel.value:'';
  for(var i=0;i<voices.length;i++){ if(voices[i].name===wanted){ chosen=voices[i]; break; } }
  if(!chosen){ for(var i2=0;i2<voices.length;i2++){ if(/Samantha/.test(voices[i2].name)){ chosen=voices[i2]; break; } } }
  if(!chosen){ for(var i3=0;i3<voices.length;i3++){ if(voices[i3].lang==='en-US'){ chosen=voices[i3]; break; } } }
  if(!chosen){ for(var i4=0;i4<voices.length;i4++){ var L=(voices[i4].lang||'').toLowerCase(); if(L.indexOf('en')===0){ chosen=voices[i4]; break; } } }
  if(!chosen && voices.length) chosen=voices[0];
  if(chosen){ u.voice=chosen; u.lang=chosen.lang||'en-US'; } else { u.lang='en-US'; }
  u.rate=parseFloat(rateEl?rateEl.value:'0.9')||0.9;
  u.pitch=parseFloat(pitchEl?pitchEl.value:'0.9')||0.9;
  u.onstart=function(){ txLamp.classList.remove('hidden'); };
  u.onend=function(){ txLamp.classList.add('hidden'); };
  try{ window.speechSynthesis.cancel(); }catch(_){}
  window.speechSynthesis.speak(u);
}

/* ===== Core ===== */
var MIN_ALT=3000, MAX_ALT=7500, SPD_MIN=160, SPD_MAX=210;
function $(id){ return document.getElementById(id); }
var h1=$('h1'),h2=$('h2'),h3=$('h3'),a1=$('a1'),a2=$('a2'),s1=$('s1'),s2=$('s2');
var hdgPreview=$('hdgPreview'),altPreview=$('altPreview'),spdPreview=$('spdPreview');
var textOut=$('textOut'),blurHint=$('blurHint'),difficultySel=$('difficulty');
var sayAgainBtn=$('sayAgain'),nextBtn=$('next'),initBtn=$('btnInit'),reinitBtn=$('btnReinit');
var logList=$('logList'),headingBlock=$('headingBlock'),altBlock=$('altBlock'),speedBlock=$('speedBlock');
var backdrop=$('backdrop'),sheet=$('sheet'),kpTarget=$('kpTarget'),kpClose=$('kpClose');
var apprMinBlock=$('apprMinBlock'),apprMaxBlock=$('apprMaxBlock');
var pmin1=$('pmin1'),pmin2=$('pmin2'),pmin3=$('pmin3'),pmax1=$('pmax1'),pmax2=$('pmax2'),pmax3=$('pmax3');
var btnApproach=$('btnApproach'),apprVal=$('apprVal'),apprRangeNote=$('apprRangeNote');

var state={difficulty:3,cur_hdg:0,cur_alt:3000,cur_spd:160,lastText:"",lastTTS:"",activeInput:null,editSeq:false,order:[h1,h2,h3,a1,a2,s1,s2]};

/* --- Approach용 시퀀스 제어 --- */
var approachSeq=false;
var approachOrder=[];    // [pmin1,pmin2,pmin3] 또는 [pmax1,pmax2,pmax3]

function clampAlt(a){ a=parseInt(a||0,10); if(a<MIN_ALT)a=MIN_ALT; if(a>MAX_ALT)a=MAX_ALT; return a; }
function clampSpd(s){ s=parseInt(s||0,10); if(s<SPD_MIN)s=SPD_MIN; if(s>SPD_MAX)s=SPD_MAX; return s; }
function hdgSpdInAviation(n){ n=Math.max(0,Math.min(999,parseInt(n||0,10))); var s=(''+n).padStart(3,'0'); var A=['Zero','One','Two','Tree','Four','Fife','Six','Seven','Eight','Niner']; return [A[parseInt(s[0],10)],A[parseInt(s[1],10)],A[parseInt(s[2],10)]]; }
function altFpmInAviation(v){ v=Math.max(0,parseInt(v||0,10)); var A=['Zero','One','Two','Tree','Four','Fife','Six','Seven','Eight','Niner']; var t=Math.floor(v/1000), h=Math.floor((v%1000)/100); var p=[]; if(t)p.push(A[t]+' Thousand'); if(h)p.push(A[h]+' Hundred'); if(!p.length)p.push(A[0]+' Hundred'); return p.join(' '); }
function digitsToInt(){ var s=''; for(var i=0;i<arguments.length;i++){ var x=arguments[i]; var v=(x.value||'0').replace(/\D/g,'').slice(0,1); s+=v; } return parseInt(s||'0',10); }
function updatePreviews(){ var hdg=(digitsToInt(h1,h2,h3))%360, alt=digitsToInt(a1,a2)*100, spd=digitsToInt(s1,s2)*10; hdgPreview.textContent='HDG: '+(''+hdg).padStart(3,'0')+'°'; altPreview.textContent='ALT: '+alt+' ft'; spdPreview.textContent='SPD: '+spd+' kt'; }
function addFocusRing(elm){ var arr=state.order.concat([pmin1,pmin2,pmin3,pmax1,pmax2,pmax3]); for(var i=0;i<arr.length;i++){ if(arr[i]) arr[i].classList.remove('focus-ring'); } if(elm) elm.classList.add('focus-ring'); }
function openKeypad(inputEl){ state.activeInput=inputEl; kpTarget.textContent=inputEl.id.toUpperCase(); backdrop.style.display='block'; sheet.classList.add('show'); addFocusRing(inputEl); }
function closeKeypad(){ sheet.classList.remove('show'); backdrop.style.display='none'; state.activeInput=null; addFocusRing(null); state.editSeq=false; approachSeq=false; approachOrder=[]; }
function focusSection(section){ var target=(section==='H')?h1:(section==='A')?a1:s1; openKeypad(target); state.editSeq=true; }

headingBlock.addEventListener('click',function(){ focusSection('H'); });
altBlock.addEventListener('click',function(){ focusSection('A'); });
speedBlock.addEventListener('click',function(){ focusSection('S'); });

/* Min/Max: 3자리 모두 입력 전까지 팝업 유지 */
apprMinBlock.addEventListener('click',function(e){
  var t=e.target && e.target.classList && e.target.classList.contains('digit') ? e.target : pmin1;
  approachSeq=true; approachOrder=[pmin1,pmin2,pmin3];
  openKeypad(t);
});
apprMaxBlock.addEventListener('click',function(e){
  var t=e.target && e.target.classList && e.target.classList.contains('digit') ? e.target : pmax1;
  approachSeq=true; approachOrder=[pmax1,pmax2,pmax3];
  openKeypad(t);
});

sheet.addEventListener('click',function(e){
  var btn=e.target; while(btn && !btn.classList.contains('kp-btn')) btn=btn.parentNode;
  if(!btn || !state.activeInput) return;
  var func=btn.getAttribute('data-func');
  if(func==='clear'){ state.activeInput.value=''; updatePreviews(); updateApprNote(); return; }
  if(func==='back'){ state.activeInput.value=''; updatePreviews(); updateApprNote();
    if(state.editSeq){ var idx=state.order.indexOf(state.activeInput); if(idx>0) openKeypad(state.order[idx-1]); else closeKeypad(); }
    else if(approachSeq){ var idxx=approachOrder.indexOf(state.activeInput); if(idxx>0) openKeypad(approachOrder[idxx-1]); else closeKeypad(); }
    else closeKeypad();
    return;
  }
  var num=(btn.textContent||'').trim();
  if(/^\d$/.test(num)){
    state.activeInput.value=num; updatePreviews(); updateApprNote();
    if(state.editSeq){
      var i=state.order.indexOf(state.activeInput);
      if(i<state.order.length-1) openKeypad(state.order[i+1]); else closeKeypad();
    } else if (approachSeq){
      var j=approachOrder.indexOf(state.activeInput);
      if(j<approachOrder.length-1) openKeypad(approachOrder[j+1]); else closeKeypad();
    } else {
      closeKeypad();
    }
  }
});
backdrop.addEventListener('click',function(){ closeKeypad(); });
kpClose.addEventListener('click',function(){ closeKeypad(); });

/* 버튼 이벤트 */
$('btnInit').addEventListener('click', doInitialize);
$('btnReinit').addEventListener('click', doReinitialize);
$('sayAgain').addEventListener('click', function(){ if(state.lastTTS) speak(state.lastTTS); });
$('next').addEventListener('click', emitInstruction);
$('btnApproach').addEventListener('click', function(){ genApproach(true); });

/* 키보드 */
document.addEventListener('keydown',function(e){
  var k=e.key;
  if(k==='n'||k==='N'){ e.preventDefault(); emitInstruction(); return; }
  if(k==='b'||k==='B'){ e.preventDefault(); if(state.lastTTS) speak(state.lastTTS); return; }
  if(k==='i'||k==='I'){ e.preventDefault(); doInitialize(); return; }
  if(k==='r'||k==='R'){ e.preventDefault(); doReinitialize(); return; }
  if(k==='h'||k==='H'){ e.preventDefault(); focusSection('H'); return; }
  if(k==='a'||k==='A'){ e.preventDefault(); focusSection('A'); return; }
  if(k==='s'||k==='S'){ e.preventDefault(); focusSection('S'); return; }
  if(k==='g'||k==='G'){ e.preventDefault(); genApproach(true); return; } /* G키로 생성 + TTS */
  if(e.code==='Space'){ e.preventDefault(); var isBlur=textOut.classList.contains('blurred');
    if(isBlur){ textOut.classList.remove('blurred'); blurHint.classList.add('hidden'); }
    else{ textOut.classList.add('blurred'); blurHint.classList.remove('hidden'); }
    return;
  }
  /* 어프로치 필드는 키보드 입력 금지 */
  var apprSet=[pmin1,pmin2,pmin3,pmax1,pmax2,pmax3];
  if(state.activeInput && apprSet.indexOf(state.activeInput)!==-1){ e.stopPropagation(); return; }
  /* 일반 입력: 숫자 */
  if(state.activeInput && /^[0-9]$/.test(k)){ e.preventDefault(); state.activeInput.value=k; updatePreviews();
    if(state.editSeq){ var idx=state.order.indexOf(state.activeInput); if(idx<state.order.length-1) openKeypad(state.order[idx+1]); else closeKeypad(); }
    else closeKeypad(); }
  if(state.activeInput && k==='Backspace'){ e.preventDefault(); state.activeInput.value=''; updatePreviews(); }
});

/* 상태/로직 */
function readInputsToState(){
  var hdg=digitsToInt(h1,h2,h3)%360, alt=clampAlt(digitsToInt(a1,a2)*100), spd=clampSpd(digitsToInt(s1,s2)*10);
  state.cur_hdg=hdg; state.cur_alt=alt; state.cur_spd=spd; state.difficulty=parseInt(difficultySel.value,10);
  $('initMsg').textContent='초기화 완료';
}
function doInitialize(){
  readInputsToState();
  textOut.textContent='Initialized. Next Instruction을 누르세요.';
  textOut.classList.add('blurred'); blurHint.classList.remove('hidden');
}
function doReinitialize(){
  doInitialize();
  textOut.textContent='Reinitialized. Next Instruction을 누르세요.';
}

/* ---- Approach Speed ---- */
function readApprMin(){ return digitsToInt(pmin1,pmin2,pmin3) || 145; }
function readApprMax(){ return digitsToInt(pmax1,pmax2,pmax3) || 152; }
function updateApprNote(){
  var mn=readApprMin(), mx=readApprMax();
  var lo=Math.min(mn,mx), hi=Math.max(mn,mx);
  apprRangeNote.textContent='범위: '+lo+'–'+hi+' kt';
}
function genApproach(doTTS){
  var mn=readApprMin(), mx=readApprMax(); if(mn>mx){ var t=mn; mn=mx; mx=t; }
  var v = Math.floor(Math.random()*(mx-mn+1))+mn;
  apprVal.textContent = v+' kt';
  if(doTTS){ 
    var w = digitsAvi(v); // "One Four Two"
    speak('Approach Speed '+w+' knots, Approach Speed '+w+' knots'); }
}
updateApprNote();

/* ---- Instruction ---- */
function getInstruction(d,cur_hdg,cur_alt,cur_spd){
  var turnd=Math.floor(Math.random()*2)+1;
  var target_hdg=cur_hdg, climb_descend=Math.floor(Math.random()*2);
  var target_alt=cur_alt, target_spd=cur_spd, target_fpm=1000;
  if(cur_alt<=MIN_ALT) climb_descend=1;
  if(cur_alt>=MAX_ALT) climb_descend=0;

  if(d===1){
    target_hdg=(cur_hdg+180)%360;
    var step1=Math.random()<0.5?1000:2000;
    target_alt=clampAlt(cur_alt+(climb_descend?+step1:-step1));
    target_spd=cur_spd;
    target_fpm=Math.random()<0.5?1000:1500;
  }else if(d===2){
    target_hdg=(cur_hdg+180)%360;
    var step2=Math.random()<0.5?1000:2000;
    target_alt=clampAlt(cur_alt+(climb_descend?+step2:-step2));
    var dv=Math.random()<0.5?-20:+20;
    target_spd=clampSpd(cur_spd+dv);
    target_fpm=Math.random()<0.5?1000:1500;
  }else{
    var delta5=(Math.floor(Math.random()*27)+10)*5;
    target_hdg=((cur_hdg+(turnd===1?-delta5:+delta5))%360+360)%360;
    var up=[1000,1500,2000], down=[1500,2000];
    var stepH=(climb_descend?up[Math.floor(Math.random()*up.length)]:down[Math.floor(Math.random()*down.length)]);
    target_alt=clampAlt(cur_alt+(climb_descend?+stepH:-stepH));
    target_spd=clampSpd(cur_spd+((Math.floor(Math.random()*3)-1)*20));
    target_fpm=(Math.floor(Math.random()*13)+9)*100;
    target_hdg=target_hdg-(target_hdg%10);
  }
  return [turnd,target_hdg,climb_descend,target_alt,target_spd,target_fpm];
}
function emitInstruction(){
  if(state.lastText){
    var item=document.createElement('div'); item.className='log-item mono'; item.textContent=state.lastText; logList.prepend(item);
  }
  var out=getInstruction(state.difficulty,state.cur_hdg,state.cur_alt,state.cur_spd);
  var turnd=out[0], target_hdg=out[1], climbdescend=out[2], target_alt=out[3], target_spd=out[4], target_fpm=out[5];
  target_hdg=((target_hdg%360)+360)%360;

  var text='Korean air one two three tango, Turn '+(turnd===1?'Left':'Right')+' heading '+(''+target_hdg).padStart(3,'0')+', '+(climbdescend===0?'Descend and maintain ':'Climb and Maintain ')+target_alt+' Speed '+target_spd+' Rate '+target_fpm;
  var ha=hdgSpdInAviation(target_hdg), sa=hdgSpdInAviation(target_spd);
  var tts='Korean air one two three tango, Turn '+(turnd===1?'Left':'Right')+' heading '+ha[0]+ha[1]+ha[2]+', '+(climbdescend===0?'Descend and maintain ':'Climb and Maintain ')+altFpmInAviation(target_alt)+', Speed '+sa[0]+sa[1]+sa[2]+', Rate '+altFpmInAviation(target_fpm);

  state.lastText=text; state.lastTTS=tts;
  state.cur_hdg=target_hdg; state.cur_alt=target_alt; state.cur_spd=target_spd;

  textOut.textContent=text; textOut.classList.add('blurred'); blurHint.classList.remove('hidden');
  speak(tts);
}

/* 기본값 */
function setDefaultInputs(hdg,alt,spd){
  hdg=(typeof hdg==='number')?hdg:330; alt=(typeof alt==='number')?alt:3000; spd=(typeof spd==='number')?spd:170;
  var h=(''+hdg).padStart(3,'0'); h1.value=h[0]; h2.value=h[1]; h3.value=h[2];
  var a=(''+Math.round(alt/100)).padStart(2,'0'); a1.value=a[0]; a2.value=a[1];
  var s=(''+Math.round(spd/10)).padStart(2,'0'); s1.value=s[0]; s2.value=s[1];
  updatePreviews();
}
function setDefaultApproach(minv,maxv){
  minv=(typeof minv==='number')?minv:145; maxv=(typeof maxv==='number')?maxv:152;
  var mn=(''+minv).padStart(3,'0'); pmin1.value=mn[0]; pmin2.value=mn[1]; pmin3.value=mn[2];
  var mx=(''+maxv).padStart(3,'0'); pmax1.value=mx[0]; pmax2.value=mx[1]; pmax3.value=mx[2];
  updateApprNote();
}
setDefaultInputs(330,3000,170);
setDefaultApproach(145,152);
textOut.textContent='숫자를 입력한 뒤 Initialize(I/R) 또는 Next(N)를 사용하세요. Approach 범위는 카드에서 팝업 키패드로 조정.';

/* PWA SW 등록은 필요 시 사용하세요
if('serviceWorker' in navigator){
  window.addEventListener('load', function(){ navigator.serviceWorker.register('./service-worker.js?v=5'); });
}
*/
</script>
</body>
</html>
